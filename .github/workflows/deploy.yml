name: Deploy on HF

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v3

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}

      - name: Sync dependencies
        run: uv sync

      - name: Configure DVC credentials
        run: |
          uv run dvc remote modify origin --local access_key_id ${{ secrets.DAGSHUB_TOKEN }}
          uv run dvc remote modify origin --local secret_access_key ${{ secrets.DAGSHUB_TOKEN }}

      - name: Download data and models from DagsHub
        run: uv run dvc pull

      - name: Run pytest tests
        run: |
          set -euo pipefail
          echo "Running pytest tests..."
          uv run pytest tests/ -v --tb=short

      - name: Run GX validation scripts
        run: |
          set -euo pipefail
          echo "Running GX validation scripts..."
          uv run python tests/test_heart_data/raw_test.py
          uv run python tests/test_heart_data/processed_test.py

  sync:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Sync specific files to deploy branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="deploy"

          ITEMS=(
            "predicting_outcomes_in_heart_failure"
            "pyproject.toml"
            "uv.lock"
            "dvc.yaml"
            ".dvc"
            "dvc.lock"
            "README.md"
            "Dockerfile"
            "prometheus.yml"
          )

          mkdir -p /tmp/to-deploy
          for item in "${ITEMS[@]}"; do
            if [ -e "$item" ]; then
              mkdir -p "/tmp/to-deploy/$(dirname "$item")"
              cp -r "$item" "/tmp/to-deploy/$item"
            fi
          done

          git fetch origin $BRANCH
          git checkout $BRANCH

          for item in "${ITEMS[@]}"; do
            if [ -e "/tmp/to-deploy/$item" ]; then
              rm -rf "./$item"
              mkdir -p "$(dirname "./$item")"
              cp -r "/tmp/to-deploy/$item" "./$item"
            fi
          done

          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Sync from main@${GITHUB_SHA::7}"
            git push origin $BRANCH
          fi

  deploy-to-hf:
    needs: sync
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git remote add hf https://user:$HF_TOKEN@huggingface.co/spaces/CardioTrack/CardioTrackTest
          git push hf deploy:main --force

      - name: Wait for HF Space to be ready
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface-hub
          python -c "
          import time
          import sys
          from huggingface_hub import HfApi
          api = HfApi(token='${{ secrets.HF_TOKEN }}')
          space_id = 'CardioTrack/CardioTrackTest'
          max_wait = 600
          poll_interval = 30
          elapsed = 0
          while elapsed < max_wait:
              info = api.space_info(space_id)
              stage = info.runtime.stage if info.runtime else 'UNKNOWN'
              if stage == 'RUNNING':
                  sys.exit(0)
              elif stage in ('BUILD_ERROR', 'RUNTIME_ERROR', 'CONFIG_ERROR'):
                  print(f'Deployment failed with stage: {stage}')
                  sys.exit(1)
              time.sleep(poll_interval)
              elapsed += poll_interval
          sys.exit(1)
          "